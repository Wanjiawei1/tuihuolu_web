# 退火炉监控系统 - 部署运维指南

## 🎯 部署清单

### 环境要求
- **操作系统**: Linux/Windows/macOS
- **Node.js**: 14.0+ (推荐 16.x LTS)
- **内存**: 最低512MB，推荐2GB
- **磁盘**: 最低1GB可用空间
- **网络**: 可访问MQTT服务器

### 依赖检查
```bash
# 检查Node.js版本
node --version  # 应该 >= 14.0

# 检查npm版本
npm --version   # 应该 >= 6.0

# 检查网络连通性
ping Mqtt.dxiot.liju.cc
```

## 🚀 部署步骤

### 1. 获取代码
```bash
# 克隆仓库
git clone https://github.com/Wanjiawei1/tuihuolu_web.git
cd tuihuolu_web

# 或者直接下载ZIP包解压
```

### 2. 安装依赖
```bash
# 安装项目依赖
npm install

# 验证安装结果
npm list --depth=0
```

### 3. 配置检查
```bash
# 检查配置文件
cat server.js | grep MQTT_BROKER_URL
cat server.js | grep PORT

# 如需修改配置，编辑server.js文件
```

### 4. 启动测试
```bash
# 开发模式启动
node server.js

# 验证启动成功
curl http://localhost:3000
```

## 🏭 生产环境部署

### 方案一：PM2进程管理（推荐）

```bash
# 1. 安装PM2
npm install -g pm2

# 2. 创建PM2配置文件
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'tuihuolu-monitor',
    script: 'server.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
}
EOF

# 3. 启动应用
pm2 start ecosystem.config.js

# 4. 设置开机自启
pm2 startup
pm2 save

# 5. 常用管理命令
pm2 status          # 查看状态
pm2 logs            # 查看日志
pm2 restart all     # 重启应用
pm2 stop all        # 停止应用
```

### 方案二：Docker容器化

```bash
# 1. 创建Dockerfile
cat > Dockerfile << EOF
FROM node:16-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install --production
COPY . .
EXPOSE 3000
CMD ["node", "server.js"]
EOF

# 2. 构建镜像
docker build -t tuihuolu-monitor:latest .

# 3. 运行容器
docker run -d \
  --name tuihuolu-monitor \
  --restart unless-stopped \
  -p 3000:3000 \
  -v $(pwd)/data.json:/app/data.json \
  tuihuolu-monitor:latest

# 4. 容器管理
docker ps                    # 查看状态
docker logs tuihuolu-monitor # 查看日志
docker restart tuihuolu-monitor # 重启容器
```

### 方案三：系统服务

```bash
# 1. 创建systemd服务文件
sudo tee /etc/systemd/system/tuihuolu-monitor.service > /dev/null <<EOF
[Unit]
Description=Tuihuolu Monitor Service
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/tuihuolu_web
ExecStart=/usr/bin/node server.js
Restart=always
RestartSec=10
Environment=NODE_ENV=production
Environment=PORT=3000

[Install]
WantedBy=multi-user.target
EOF

# 2. 启用并启动服务
sudo systemctl daemon-reload
sudo systemctl enable tuihuolu-monitor
sudo systemctl start tuihuolu-monitor

# 3. 服务管理
sudo systemctl status tuihuolu-monitor  # 查看状态
sudo systemctl restart tuihuolu-monitor # 重启服务
sudo journalctl -u tuihuolu-monitor -f  # 查看日志
```

## 🔧 反向代理配置

### Nginx配置
```nginx
# /etc/nginx/sites-available/tuihuolu-monitor
server {
    listen 80;
    server_name your-domain.com;  # 替换为实际域名
    
    # 静态文件缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # WebSocket支持
    location /socket.io/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 主要应用
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# 启用配置
sudo ln -s /etc/nginx/sites-available/tuihuolu-monitor /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### Apache配置
```apache
# /etc/apache2/sites-available/tuihuolu-monitor.conf
<VirtualHost *:80>
    ServerName your-domain.com
    
    ProxyPreserveHost On
    ProxyRequests Off
    
    # WebSocket支持
    ProxyPass /socket.io/ ws://localhost:3000/socket.io/
    ProxyPassReverse /socket.io/ ws://localhost:3000/socket.io/
    
    # 主要应用
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/
</VirtualHost>

# 启用模块和配置
sudo a2enmod proxy
sudo a2enmod proxy_http
sudo a2enmod proxy_wstunnel
sudo a2ensite tuihuolu-monitor
sudo systemctl reload apache2
```

## 📊 监控和日志

### 日志管理
```bash
# PM2日志
pm2 logs tuihuolu-monitor --lines 100

# 系统服务日志
sudo journalctl -u tuihuolu-monitor -f

# 应用日志轮转
sudo tee /etc/logrotate.d/tuihuolu-monitor > /dev/null <<EOF
/var/log/tuihuolu-monitor/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    create 644 www-data www-data
}
EOF
```

### 系统监控
```bash
# 资源使用监控脚本
cat > monitor.sh << 'EOF'
#!/bin/bash
echo "=== 系统资源监控 ===" 
echo "时间: $(date)"
echo "CPU使用率: $(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}')"
echo "内存使用: $(free -h | awk 'NR==2{printf "%.1f%%", $3*100/$2 }')"
echo "磁盘使用: $(df -h | awk '$NF=="/"{printf "%s", $5}')"
echo "进程状态: $(pm2 list | grep tuihuolu-monitor | awk '{print $12}')"
echo "端口监听: $(netstat -tlnp | grep :3000)"
echo "========================"
EOF

chmod +x monitor.sh

# 定时监控 (每5分钟)
(crontab -l 2>/dev/null; echo "*/5 * * * * /path/to/monitor.sh >> /var/log/tuihuolu-monitor.log") | crontab -
```

## 🔒 安全配置

### 防火墙设置
```bash
# UFW防火墙配置
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw deny 3000/tcp  # 仅允许内部访问
sudo ufw enable

# iptables配置
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 3000 -s 127.0.0.1 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 3000 -j DROP
```

### SSL证书配置
```bash
# Let's Encrypt免费证书
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加: 0 12 * * * /usr/bin/certbot renew --quiet
```

## 💾 备份策略

### 数据备份脚本
```bash
cat > backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/backup/tuihuolu"
DATE=$(date +%Y%m%d_%H%M%S)
APP_DIR="/opt/tuihuolu_web"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据文件
cp $APP_DIR/data.json $BACKUP_DIR/data_$DATE.json

# 备份配置文件
tar -czf $BACKUP_DIR/config_$DATE.tar.gz $APP_DIR/server.js $APP_DIR/package.json

# 清理7天前的备份
find $BACKUP_DIR -name "*.json" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "备份完成: $DATE"
EOF

chmod +x backup.sh

# 每日凌晨2点自动备份
(crontab -l 2>/dev/null; echo "0 2 * * * /path/to/backup.sh") | crontab -
```

## 🚨 故障处理

### 常见问题诊断
```bash
# 1. 服务状态检查
systemctl status tuihuolu-monitor
pm2 status

# 2. 端口占用检查
netstat -tlnp | grep 3000
lsof -i :3000

# 3. 进程检查
ps aux | grep node

# 4. 日志分析
tail -f /var/log/tuihuolu-monitor.log
journalctl -u tuihuolu-monitor --since "1 hour ago"

# 5. 网络连通性
curl -I http://localhost:3000
telnet Mqtt.dxiot.liju.cc 1883
```

### 应急处理流程
```bash
# 1. 服务重启
pm2 restart tuihuolu-monitor
# 或
sudo systemctl restart tuihuolu-monitor

# 2. 强制重启
pm2 delete tuihuolu-monitor
pm2 start ecosystem.config.js

# 3. 数据恢复
cp /backup/tuihuolu/data_latest.json /opt/tuihuolu_web/data.json

# 4. 完整重部署
cd /opt/tuihuolu_web
git pull origin master
npm install
pm2 restart tuihuolu-monitor
```

## 📈 性能优化

### Node.js优化
```bash
# 增加内存限制
node --max-old-space-size=2048 server.js

# PM2集群模式
pm2 start server.js -i max  # 使用所有CPU核心
```

### 系统优化
```bash
# 增加文件描述符限制
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# 内核参数优化
echo "net.core.somaxconn = 65535" >> /etc/sysctl.conf
sysctl -p
```

## 📞 技术支持

### 联系方式
- **紧急故障**: 电话联系运维团队
- **一般问题**: 提交GitHub Issues
- **功能建议**: 发送邮件至项目组

### 维护窗口
- **定期维护**: 每周日凌晨2:00-4:00
- **紧急维护**: 根据实际情况安排
- **版本更新**: 每月第一个周末

---

**运维团队**: IT基础设施部  
**文档版本**: v1.0  
**最后更新**: 2025年9月2日
