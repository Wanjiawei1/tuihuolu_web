# é€€ç«ç‚‰ç›‘æ§ç³»ç»Ÿ - éƒ¨ç½²è¿ç»´æŒ‡å—

## ğŸ¯ éƒ¨ç½²æ¸…å•

### ç¯å¢ƒè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Linux/Windows/macOS
- **Node.js**: 14.0+ (æ¨è 16.x LTS)
- **å†…å­˜**: æœ€ä½512MBï¼Œæ¨è2GB
- **ç£ç›˜**: æœ€ä½1GBå¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: å¯è®¿é—®MQTTæœåŠ¡å™¨

### ä¾èµ–æ£€æŸ¥
```bash
# æ£€æŸ¥Node.jsç‰ˆæœ¬
node --version  # åº”è¯¥ >= 14.0

# æ£€æŸ¥npmç‰ˆæœ¬
npm --version   # åº”è¯¥ >= 6.0

# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping Mqtt.dxiot.liju.cc
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. è·å–ä»£ç 
```bash
# å…‹éš†ä»“åº“
git clone https://github.com/Wanjiawei1/tuihuolu_web.git
cd tuihuolu_web

# æˆ–è€…ç›´æ¥ä¸‹è½½ZIPåŒ…è§£å‹
```

### 2. å®‰è£…ä¾èµ–
```bash
# å®‰è£…é¡¹ç›®ä¾èµ–
npm install

# éªŒè¯å®‰è£…ç»“æœ
npm list --depth=0
```

### 3. é…ç½®æ£€æŸ¥
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat server.js | grep MQTT_BROKER_URL
cat server.js | grep PORT

# å¦‚éœ€ä¿®æ”¹é…ç½®ï¼Œç¼–è¾‘server.jsæ–‡ä»¶
```

### 4. å¯åŠ¨æµ‹è¯•
```bash
# å¼€å‘æ¨¡å¼å¯åŠ¨
node server.js

# éªŒè¯å¯åŠ¨æˆåŠŸ
curl http://localhost:3000
```

## ğŸ­ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### æ–¹æ¡ˆä¸€ï¼šPM2è¿›ç¨‹ç®¡ç†ï¼ˆæ¨èï¼‰

```bash
# 1. å®‰è£…PM2
npm install -g pm2

# 2. åˆ›å»ºPM2é…ç½®æ–‡ä»¶
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'tuihuolu-monitor',
    script: 'server.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
}
EOF

# 3. å¯åŠ¨åº”ç”¨
pm2 start ecosystem.config.js

# 4. è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save

# 5. å¸¸ç”¨ç®¡ç†å‘½ä»¤
pm2 status          # æŸ¥çœ‹çŠ¶æ€
pm2 logs            # æŸ¥çœ‹æ—¥å¿—
pm2 restart all     # é‡å¯åº”ç”¨
pm2 stop all        # åœæ­¢åº”ç”¨
```

### æ–¹æ¡ˆäºŒï¼šDockerå®¹å™¨åŒ–

```bash
# 1. åˆ›å»ºDockerfile
cat > Dockerfile << EOF
FROM node:16-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install --production
COPY . .
EXPOSE 3000
CMD ["node", "server.js"]
EOF

# 2. æ„å»ºé•œåƒ
docker build -t tuihuolu-monitor:latest .

# 3. è¿è¡Œå®¹å™¨
docker run -d \
  --name tuihuolu-monitor \
  --restart unless-stopped \
  -p 3000:3000 \
  -v $(pwd)/data.json:/app/data.json \
  tuihuolu-monitor:latest

# 4. å®¹å™¨ç®¡ç†
docker ps                    # æŸ¥çœ‹çŠ¶æ€
docker logs tuihuolu-monitor # æŸ¥çœ‹æ—¥å¿—
docker restart tuihuolu-monitor # é‡å¯å®¹å™¨
```

### æ–¹æ¡ˆä¸‰ï¼šç³»ç»ŸæœåŠ¡

```bash
# 1. åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶
sudo tee /etc/systemd/system/tuihuolu-monitor.service > /dev/null <<EOF
[Unit]
Description=Tuihuolu Monitor Service
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/tuihuolu_web
ExecStart=/usr/bin/node server.js
Restart=always
RestartSec=10
Environment=NODE_ENV=production
Environment=PORT=3000

[Install]
WantedBy=multi-user.target
EOF

# 2. å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl enable tuihuolu-monitor
sudo systemctl start tuihuolu-monitor

# 3. æœåŠ¡ç®¡ç†
sudo systemctl status tuihuolu-monitor  # æŸ¥çœ‹çŠ¶æ€
sudo systemctl restart tuihuolu-monitor # é‡å¯æœåŠ¡
sudo journalctl -u tuihuolu-monitor -f  # æŸ¥çœ‹æ—¥å¿—
```

## ğŸ”§ åå‘ä»£ç†é…ç½®

### Nginxé…ç½®
```nginx
# /etc/nginx/sites-available/tuihuolu-monitor
server {
    listen 80;
    server_name your-domain.com;  # æ›¿æ¢ä¸ºå®é™…åŸŸå
    
    # é™æ€æ–‡ä»¶ç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # WebSocketæ”¯æŒ
    location /socket.io/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ä¸»è¦åº”ç”¨
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# å¯ç”¨é…ç½®
sudo ln -s /etc/nginx/sites-available/tuihuolu-monitor /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### Apacheé…ç½®
```apache
# /etc/apache2/sites-available/tuihuolu-monitor.conf
<VirtualHost *:80>
    ServerName your-domain.com
    
    ProxyPreserveHost On
    ProxyRequests Off
    
    # WebSocketæ”¯æŒ
    ProxyPass /socket.io/ ws://localhost:3000/socket.io/
    ProxyPassReverse /socket.io/ ws://localhost:3000/socket.io/
    
    # ä¸»è¦åº”ç”¨
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/
</VirtualHost>

# å¯ç”¨æ¨¡å—å’Œé…ç½®
sudo a2enmod proxy
sudo a2enmod proxy_http
sudo a2enmod proxy_wstunnel
sudo a2ensite tuihuolu-monitor
sudo systemctl reload apache2
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—ç®¡ç†
```bash
# PM2æ—¥å¿—
pm2 logs tuihuolu-monitor --lines 100

# ç³»ç»ŸæœåŠ¡æ—¥å¿—
sudo journalctl -u tuihuolu-monitor -f

# åº”ç”¨æ—¥å¿—è½®è½¬
sudo tee /etc/logrotate.d/tuihuolu-monitor > /dev/null <<EOF
/var/log/tuihuolu-monitor/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    create 644 www-data www-data
}
EOF
```

### ç³»ç»Ÿç›‘æ§
```bash
# èµ„æºä½¿ç”¨ç›‘æ§è„šæœ¬
cat > monitor.sh << 'EOF'
#!/bin/bash
echo "=== ç³»ç»Ÿèµ„æºç›‘æ§ ===" 
echo "æ—¶é—´: $(date)"
echo "CPUä½¿ç”¨ç‡: $(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}')"
echo "å†…å­˜ä½¿ç”¨: $(free -h | awk 'NR==2{printf "%.1f%%", $3*100/$2 }')"
echo "ç£ç›˜ä½¿ç”¨: $(df -h | awk '$NF=="/"{printf "%s", $5}')"
echo "è¿›ç¨‹çŠ¶æ€: $(pm2 list | grep tuihuolu-monitor | awk '{print $12}')"
echo "ç«¯å£ç›‘å¬: $(netstat -tlnp | grep :3000)"
echo "========================"
EOF

chmod +x monitor.sh

# å®šæ—¶ç›‘æ§ (æ¯5åˆ†é’Ÿ)
(crontab -l 2>/dev/null; echo "*/5 * * * * /path/to/monitor.sh >> /var/log/tuihuolu-monitor.log") | crontab -
```

## ğŸ”’ å®‰å…¨é…ç½®

### é˜²ç«å¢™è®¾ç½®
```bash
# UFWé˜²ç«å¢™é…ç½®
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw deny 3000/tcp  # ä»…å…è®¸å†…éƒ¨è®¿é—®
sudo ufw enable

# iptablesé…ç½®
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 3000 -s 127.0.0.1 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 3000 -j DROP
```

### SSLè¯ä¹¦é…ç½®
```bash
# Let's Encryptå…è´¹è¯ä¹¦
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ : 0 12 * * * /usr/bin/certbot renew --quiet
```

## ğŸ’¾ å¤‡ä»½ç­–ç•¥

### æ•°æ®å¤‡ä»½è„šæœ¬
```bash
cat > backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/backup/tuihuolu"
DATE=$(date +%Y%m%d_%H%M%S)
APP_DIR="/opt/tuihuolu_web"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®æ–‡ä»¶
cp $APP_DIR/data.json $BACKUP_DIR/data_$DATE.json

# å¤‡ä»½é…ç½®æ–‡ä»¶
tar -czf $BACKUP_DIR/config_$DATE.tar.gz $APP_DIR/server.js $APP_DIR/package.json

# æ¸…ç†7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.json" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "å¤‡ä»½å®Œæˆ: $DATE"
EOF

chmod +x backup.sh

# æ¯æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨å¤‡ä»½
(crontab -l 2>/dev/null; echo "0 2 * * * /path/to/backup.sh") | crontab -
```

## ğŸš¨ æ•…éšœå¤„ç†

### å¸¸è§é—®é¢˜è¯Šæ–­
```bash
# 1. æœåŠ¡çŠ¶æ€æ£€æŸ¥
systemctl status tuihuolu-monitor
pm2 status

# 2. ç«¯å£å ç”¨æ£€æŸ¥
netstat -tlnp | grep 3000
lsof -i :3000

# 3. è¿›ç¨‹æ£€æŸ¥
ps aux | grep node

# 4. æ—¥å¿—åˆ†æ
tail -f /var/log/tuihuolu-monitor.log
journalctl -u tuihuolu-monitor --since "1 hour ago"

# 5. ç½‘ç»œè¿é€šæ€§
curl -I http://localhost:3000
telnet Mqtt.dxiot.liju.cc 1883
```

### åº”æ€¥å¤„ç†æµç¨‹
```bash
# 1. æœåŠ¡é‡å¯
pm2 restart tuihuolu-monitor
# æˆ–
sudo systemctl restart tuihuolu-monitor

# 2. å¼ºåˆ¶é‡å¯
pm2 delete tuihuolu-monitor
pm2 start ecosystem.config.js

# 3. æ•°æ®æ¢å¤
cp /backup/tuihuolu/data_latest.json /opt/tuihuolu_web/data.json

# 4. å®Œæ•´é‡éƒ¨ç½²
cd /opt/tuihuolu_web
git pull origin master
npm install
pm2 restart tuihuolu-monitor
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### Node.jsä¼˜åŒ–
```bash
# å¢åŠ å†…å­˜é™åˆ¶
node --max-old-space-size=2048 server.js

# PM2é›†ç¾¤æ¨¡å¼
pm2 start server.js -i max  # ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒ
```

### ç³»ç»Ÿä¼˜åŒ–
```bash
# å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# å†…æ ¸å‚æ•°ä¼˜åŒ–
echo "net.core.somaxconn = 65535" >> /etc/sysctl.conf
sysctl -p
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### è”ç³»æ–¹å¼
- **ç´§æ€¥æ•…éšœ**: ç”µè¯è”ç³»è¿ç»´å›¢é˜Ÿ
- **ä¸€èˆ¬é—®é¢˜**: æäº¤GitHub Issues
- **åŠŸèƒ½å»ºè®®**: å‘é€é‚®ä»¶è‡³é¡¹ç›®ç»„

### ç»´æŠ¤çª—å£
- **å®šæœŸç»´æŠ¤**: æ¯å‘¨æ—¥å‡Œæ™¨2:00-4:00
- **ç´§æ€¥ç»´æŠ¤**: æ ¹æ®å®é™…æƒ…å†µå®‰æ’
- **ç‰ˆæœ¬æ›´æ–°**: æ¯æœˆç¬¬ä¸€ä¸ªå‘¨æœ«

---

**è¿ç»´å›¢é˜Ÿ**: ITåŸºç¡€è®¾æ–½éƒ¨  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025å¹´9æœˆ2æ—¥
